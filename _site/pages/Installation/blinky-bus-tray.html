<h1 id="blinky-bus-tray">Blinky Bus Tray</h1>
<h2 id="table-of-contents">Table of contents</h2>
<ul>
  <li>Overview</li>
  <li><a href="#preparing-the-raspberry-pi">Preparing the Raspberry Pi</a></li>
  <li><a href="#pair-th-cube">Pair the Cube</a></li>
  <li><a href="#install-the-tray">Install the Tray</a></li>
  <li><a href="#setup-the-environmental-file">Setup the environmental file</a></li>
  <li><a href="#running-node-red">Running Node RED</a></li>
  <li><a href="#fixing-the-mqtt-credentials">Fixing the MQTT credentials</a></li>
  <li><a href="#starting-the-pm2-background-process">Starting the PM2 background process</a></li>
  <li><a href="#code-discussion">Code Discussion</a>
    <ul>
      <li><a href="#the-tray-json-object">The tray JSON object</a></li>
      <li><a href="#user-defined-flow-nodes">User-defined flow nodes</a>
        <ul>
          <li><a href="#create-settings-node">Create Settings Node</a></li>
          <li><a href="#create-readings-node">Create Readings node</a></li>
          <li><a href="#init-gizmo-node">Init Gizmo node</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>
<p>Blinky-Bus is a demonstration project on how to use Blinky-Lite with serial Bluetooth to communicate between the cube and tray. The function of the device is to turn on and off three LEDs. The Blinky-Lite tray software is written as a <a href="https://nodered.org/">Node-RED</a> flow and can easily run on a Raspberry Pi.</p>

<p>You can obtain the source code for the cube by either cloning the repository or downloading a zip file from the green Code button on the <a href="https://github.com/Blinky-Lite/blinky-bus-tray">Github page</a>.<br />
<img src="/assets/images/blinky-tray-img/blinkyBusCube.jpg" /><br /></p>

<h2 id="preparing-the-raspberry-pi">Preparing the Raspberry Pi</h2>
<p><a href="#table-of-contents">(contents)</a><br />
Setup an Raspberry Pi with the latest <a href="https://www.raspberrypi.com/software/operating-systems/">32 bit Raspberry Pi OS Lite</a>. It is recommended to use the Raspberry Pi <a href="https://www.raspberrypi.com/software/">Imager</a>. Once the Raspberry Pi is up and running, SSH into the Raspberry Pi and download version 16.15.0 of <a href="https://nodejs.org/en/download/">Node.js</a></p>

<p>For ARM7 (Raspberry Pi 3)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://nodejs.org/dist/v16.15.0/node-v16.15.0-linux-armv7l.tar.xz
</code></pre></div></div>

<p>For ARM6 (Raspberry Pi Zero)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://unofficial-builds.nodejs.org/download/release/v16.15.0/node-v16.15.0-linux-armv6l.tar.xz
</code></pre></div></div>

<p>Extract the file</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -xf node-v16.15.0-linux-armvXl.tar.xz
</code></pre></div></div>

<p>where X is either 6 or 7.<br />Install the directory</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd node-v16.15.0-linux-armvXl
sudo cp -R * /usr/
</code></pre></div></div>

<p>where X is either 6 or 7.<br />Check to see the version</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node -v
</code></pre></div></div>

<p>You should see v16.15.0<br />
Remove the installation directory</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ..
rm -rf node-v16.15.0-linux-armvXl
rm node-v16.15.0-linux-armvXl.tar.xz
</code></pre></div></div>

<p>where X is either 6 or 7.</p>

<p>PM2 is a handy service to run programs in background and on boot. Next install PM2 globally</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo npm install -g pm2
</code></pre></div></div>

<h2 id="pair-the-cube">Pair the Cube</h2>
<p><a href="#table-of-contents">(contents)</a><br />
Next pair the Bluetooth of the Raspberry Pi with the Bluetooth of the cube. From the Raspberry Pi:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo bluetoothctl
</code></pre></div></div>

<p>Once inside the bluetoothctl program enter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scan on
</code></pre></div></div>

<p>A list of available bluetooth devices will start to be listed. Once you see the name of your HC06 device that was setup in the <a href="https://github.com/Blinky-Lite-Exchange/blinky-bus-cube">Blinky Bus Cube</a>, turn the scan off:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scan off
</code></pre></div></div>

<p>and pair the HC06 device</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pair XX:XX:XX:XX:XX:XX
</code></pre></div></div>

<p>where <em>XX:XX:XX:XX:XX:XX</em> is the MAC address of the HC06 device you saw on the scan list. The bluetoothctl program will ask you for the PIN number you setup in the <a href="https://github.com/Blinky-Lite-Exchange/blinky-bus-cube">Blinky Bus Cube</a>. After you have successfully paired the HC06 device, exit the bluetoothctl program:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exit
</code></pre></div></div>

<p>Now you need to bind which Serial comm device for your HC06 device. At the Raspberry Pi terminal, enter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo rfcomm bind 0 XX:XX:XX:XX:XX:XX
</code></pre></div></div>

<p>where <em>XX:XX:XX:XX:XX:XX</em> is the MAC address of the HC06 device. This will bind the device serial device <strong>/dev/rfcomm0</strong> to the list of serial devices. You can see this device now by typing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls /dev
</code></pre></div></div>

<p>To remember this binding, edit the rc.local file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nano /etc/rc.local
</code></pre></div></div>

<p>and add the line  <strong>sudo rfcomm bind 0</strong> <strong><em>XX:XX:XX:XX:XX:XX</em></strong> right before the <strong>exit 0</strong> line in the file. To exit the nano editor type <strong><em>ctrl</em></strong> <strong>x</strong></p>

<h2 id="install-the-tray">Install the Tray</h2>
<p><a href="#table-of-contents">(contents)</a><br />
From the Raspberry Pi terminal, clone the tray repository or download the zip file from the green Code button on the <a href="https://github.com/Blinky-Lite-Exchange/blinky-bus-tray">Github page</a>.</p>

<p>Change directory into the tray directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd blinky-bus-tray
</code></pre></div></div>

<p>Install the code</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install
</code></pre></div></div>

<h2 id="setup-the-environmental-file">Setup the environmental file</h2>
<p><a href="#table-of-contents">(contents)</a><br />
The <strong>.env</strong> file contains environmental variables that should not be shared. A template file <strong>env</strong> is stored on the Github repository Copy the env file to .env file</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp env .env https://nodered.org/ The **.env** file should look like:

MQTTSUBSCRIBE=blinky-lite-v4/blinky-bus/01/setting/#
MQTTCLIENTID=blinky-bus-tray-01
MQTTSERVERIP=aaaa
MQTTUSERNAME=bbb
MQTTPASSWORD=ccc
SERIALPORT=/dev/rfcomm0
SERIALBUFSIZE=8
PM2NAME=blinky-bus-01
NODEREDCONFIGSECRET=dddd
</code></pre></div></div>

<p>You need to change the fields <strong>aaaa</strong>, <strong>bbbb</strong>, <strong>cccc</strong> to the appropriate values for the Blinky-Lite application Box you are going to connect to. You also need to pick a unique secret for the <strong>dddd</strong> field. This secret is used to <a href="https://discourse.nodered.org/t/your-flow-credentials-file-is-encrypted-using-a-system-generated-key/18382">encrypt the MQTT credentials in Node-RED</a>.</p>

<h2 id="running-node-red">Running Node RED</h2>
<p><a href="#table-of-contents">(contents)</a><br />
Before you run Node-RED, you need to change password in the <em>adminAuth</em> field in the <strong>settings.js</strong> file so you will be able to view and edit the tray flow from a browser. The <em>adminAuth</em> field in the <strong>settings.js</strong> file is shown below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adminAuth: {
    type: "credentials",
    users: [{
        username: "admin",
        password: "$2a$08$KaclKnSDZ7.pGtci1ZSOIep/Dqu582RURal12L7kbJ1bnv/SYPNFq",
        permissions: "*"
    }]
},
</code></pre></div></div>

<p>The password is encypted using bcrypt. Generate a new password using one of the many <a href="https://bcrypt-generator.com/">internet sites</a> that provide encryption for passwords.</p>

<p>To run Node-RED us the script in the tray directory</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./run-blinky-lite.sh $(pwd)
</code></pre></div></div>

<p>Open a browser and enter into the address bar of the browser:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://AAA.BBB.CCC.DDD:61880/admin
</code></pre></div></div>

<p>where <strong><em>AAA.BBB.CCC.DDD</em></strong> is the IP address of the Raspberry Pi and <strong>61880</strong> is the uiPort specified in the settings.js file. The browser will display:</p>

<p><img src="/assets/images/blinky-tray-img/node-red-splash.png" /><br /></p>

<h2 id="fixing-the-mqtt-credentials">Fixing the MQTT credentials</h2>
<p><a href="#table-of-contents">(contents)</a><br />
Enter the username and password defined in the adminAuth block of settings.js You will most likely see the following screen with an error message that the credentials could not be decrypted</p>

<p><img src="/assets/images/blinky-tray-img/node-red-cred-error.png" /><br /></p>

<p>Close the error message and on the right hand side of the screen is an info panel.</p>
<ul>
  <li>Expand the <strong>Global Configuration Nodes</strong> tree item,</li>
  <li>and then expand the <strong>mqtt-broker</strong> tree item.</li>
  <li>Next double click on the <strong>MQTT Broker</strong> icon</li>
  <li>and select the Security menu of the <strong>Edit mqtt-broker node</strong> panel that slid open</li>
  <li>To pickup the environmental variables specified in the .env file, enter:
    <ul>
      <li>$(MQTTUSERNAME) in the Username box</li>
      <li>$(MQTTPASSWORD) in the Password box</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/images/blinky-tray-img/Mqttsecurity.png" /><br /></p>

<ul>
  <li>Press the <strong>Update</strong> button to close <strong>Edit mqtt-broker node</strong> panel</li>
  <li>Press the <strong>Deploy</strong> button to load the flow.</li>
</ul>

<p>The flow should be working with green boxes underneath the light purple MQTT nodes indicating that they are connected.</p>

<p><img src="/assets/images/blinky-tray-img/noderedWorking.png" /><br /></p>

<h2 id="starting-the-pm2-background-process">Starting the PM2 background process</h2>
<p><a href="#table-of-contents">(contents)</a><br />
Return to the terminal on the Raspberry Pi and terminate the Node-RED script by typing <strong><em>ctrl c</em></strong>. Start the PM2 script to run Node-RED in background:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./pm2.sh $(pwd)
</code></pre></div></div>

<p>Save the PM2 state of the Raspberry Pi:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 save
</code></pre></div></div>

<p>To have the PM2 process start at boot:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pm2 startup systemd
</code></pre></div></div>

<p>The command will return with a command to paste that looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u pi --hp /home/pi
</code></pre></div></div>

<p>Paste and execute the command. Now the tray will start automatically on boot.</p>

<h2 id="code-discussion">Code Discussion</h2>
<h3 id="the-tray-json-object">The tray JSON object</h3>
<p><a href="#table-of-contents">(contents)</a><br />
The purpose of the Blinky-Lite tray is to package the data coming from the cube and send this data to the application box. Instead of sending many name-value pairs, the tray packages all of the cube data into a single <a href="https://www.w3schools.com/js/js_json_objects.asp">JSON object</a>. The definition of the tray JSON object is defined in the <strong>tray.json</strong> file.</p>

<p><img src="/assets/images/blinky-tray-img/trayJson.png" /><br /></p>

<ul>
  <li>Trays with the same <strong>type</strong> should behave the same way.</li>
  <li>The <strong>name</strong> value distinguishes trays of the same <strong>type</strong>
    <ul>
      <li>Note that the <strong>type</strong> and <strong>name</strong> must match the <a href="#setup-the-environmental-file">MQTTSUBSCRIBE </a> environmental variable</li>
    </ul>
  </li>
  <li>The <strong>arcPeriod</strong> defines how often (in milli Seconds) the application box should archive the tray.</li>
  <li>The <strong>timeStamp</strong> will be used by the application box to time stamp the tray data. It is in JavaScript millSeconds since Jan 1 1970.</li>
  <li>The <strong>watchdog</strong> is an optional cube object that the tray can increment to indicate the tray is functioning.</li>
  <li>The <strong>linkQuality</strong> and <strong>signalLevel</strong> are optional cube objects that describe the strength of the wireless signal of the Raspberry Pi determined by <strong>iwconfig</strong>.</li>
  <li>The <strong>ledX</strong> cube objects are specific to the cube and describe the LEDâ€™s behavior.
    <ul>
      <li>The <strong>action</strong> determines if it is a reading or a setting</li>
      <li>The <strong>type</strong> can be scalar (single number), vector [[],[]], or text</li>
      <li>The <strong>value</strong> and <strong>unit</strong> are self explanatory</li>
      <li>The <strong>alarm</strong> object is for scalar data types
        <ul>
          <li>an alarm value of 0 means the cube value is between <em>low</em> and <em>high</em> limits</li>
          <li>an alarm value of 1 means the cube value is less than the <em>low</em> limit</li>
          <li>an alarm value of 2 means the cube value is greater than the <em>high</em> limit</li>
          <li>an alarm value of 3 means the cube value is less than the <em>low</em> limit</li>
          <li>an alarm value of 4 means the cube value is greater than the <em>hihi</em> limit</li>
          <li>The <strong>notify</strong> object is used by the application box to send an SMS if there is an alarm</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="user-defined-flow-nodes">User-defined flow nodes</h3>
<p><a href="#table-of-contents">(contents)</a><br />
In the Node-RED flow there are three nodes where the user can customize how the tray behaves and not disturb any of the background communication functionality.</p>
<ul>
  <li>Create Setting node</li>
  <li>Create Readings node</li>
  <li>Init Gizmo node</li>
</ul>

<p>These nodes are easily identified with a purple background and a yellow <em>Edit Me</em> label.
<img src="/assets/images/blinky-tray-img/userNodes.png" /><br /></p>

<h4 id="create-settings-node">Create Settings Node</h4>
<p><a href="#table-of-contents">(contents)</a><br />
The Create Settings Node listens to the MQTT topic defined by the MQTTSUBSCRIBE environmental variable. The <strong>#</strong> wild card at the end of the MQTTSUBSCRIBE topic can take on four values</p>
<ul>
  <li><strong>setting</strong>
    <ul>
      <li>for setting a cube scalar value</li>
    </ul>
  </li>
  <li><strong>ping</strong>
    <ul>
      <li>will echo the tray back to the MQTT broker immediately</li>
    </ul>
  </li>
  <li><strong>config</strong>
    <ul>
      <li>to change the alarm configuration of a scalar cube</li>
    </ul>
  </li>
  <li><strong>reset</strong>
    <ul>
      <li>will reset the node-red tray process</li>
    </ul>
  </li>
</ul>

<p>For the setting process the MQTT payload must be of the form</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{cube:cube_name, value:x}
</code></pre></div></div>

<p>where <strong><em>x</em></strong> is an number or a string. The user must edit the <strong>Create Setting</strong> node to setup up the behavior of the setting as shown below.
<img src="/assets/images/blinky-tray-img/CreateSettingNodeCode.png" /><br /></p>

<p>The settings can be of two types:</p>
<ul>
  <li>blinkyBus settings
    <ul>
      <li>in which the user must specify the address of the blinkyBus setting.</li>
      <li>the setting is then routed to the BlinkyBus serial port.</li>
      <li>the setting value must be an integer</li>
    </ul>
  </li>
  <li>non-blinkyBus settings
    <ul>
      <li>the user can do anything with the setting such as setting a cube object in a tray</li>
      <li>or other functionality</li>
    </ul>
  </li>
</ul>

<h4 id="create-readings-node">Create Readings node</h4>
<p><a href="#table-of-contents">(contents)</a><br />
The Create Readings node takes data from BlinkyBus and populates the tray cub objects.
<img src="/assets/images/blinky-tray-img/CreateReadingsNodeCode.png" /><br /></p>

<h4 id="init-gizmo-node">Init Gizmo node</h4>
<p><a href="#table-of-contents">(contents)</a><br />
If the cube device returns a state value of 1, such as when the cube device is powered up, this node will be triggered and the node defines how the cube device should be initially configured
<img src="/assets/images/blinky-tray-img/InitGizmoNodeCode.png" /><br /></p>
